# Offer Correction

This document describes the system's flow responsible for **Offer Correction**, ensuring that the availability of service slots in the app is always up-to-date, considering the onboarding of new couriers and future absences of existing couriers.

## System Flow

1.  **Monitoring Schedule Changes:**

      * The system continuously monitors changes in the **Courier Work Schedule Management**.
      * This includes detecting newly registered couriers with their respective start-of-shift schedules.
      * It also monitors future absence notifications from couriers, including the absence period and reason.

2.  **Identifying Impact on Offer:**

      * Upon detecting a schedule change (new entry or absence), the system evaluates the potential impact on the availability of service slots over the next 30 days.
      * For new couriers, the system identifies which times and days they will be available to include in the offer.
      * For absences, the system identifies which times and days will have a reduction in courier availability.

3.  **Calculating New Availability:**

      * Based on the identified changes, the system recalculates the availability of professionals for each half-hour interval over the next 30 days.
      * For new couriers, availability is increased during their active hours.
      * For absent couriers, availability is decreased during the hours they are unavailable.

4.  **Adjusting Offer Slots:**

      * The system adjusts the offer slots in the app based on the new availability calculation.
      * New time slots can be opened if there's an increase in availability (e.g., new courier onboarding).
      * Time slots can be closed or have their capacity reduced if there's a decrease in availability (e.g., courier absence).

5.  **Updating Offer in the App:**

      * The adjusted offer is sent and updated in the client's app in real-time or in pre-defined cycles.
      * This ensures that clients only see the service slots that genuinely have courier availability.

6.  **Generating Alerts and Reports:**

      * The system can generate alerts for operational managers if schedule changes cause a significant decrease in offer during certain periods or regions.
      * Reports on the corrections made and their impact on the offer can be generated for analysis and monitoring.

## Database Tables

For the Offer Correction stage, the database tables that relate to extracted or modified information are:

  * **`OFR_AJUSTES_ESCALA`**: This table would record all changes that trigger the correction, such as new courier entries (`MOTOCICLISTA_ID` - Courier ID, `DATA_INICIO_CONTRATO` - Contract Start Date) and absence notifications (`MOTOCICLISTA_ID`, `DATA_INICIO_AUSENCIA` - Absence Start Date, `DATA_FIM_AUSENCIA` - Absence End Date, `MOTIVO_AUSENCIA` - Absence Reason).
  * **`OFR_LOG_CORRECOES`**: A table to log the corrections made, containing `DATA_CORRECAO` (Correction Date), `TIPO_CORRECAO` (Correction Type, e.g., "Inclusion", "Removal"), `MOTOCICLISTA_ID`, `HORARIO_AFETADO` (Affected Time), `SLOTS_AJUSTADOS` (Adjusted Slots).

## API Endpoints

Offer Correction depends on received information and, in turn, updates the offer.

  * **`POST https://api.yourcompany.com.br/offer/schedule-notifications`**: Endpoint that can be used by the Work Schedule Management system to notify changes (new shift, absence).
      * **Example Request**:
        ```json
        {
            "change_type": "ABSENCE",
            "courier_id": "MOTO123",
            "start_date": "2025-07-10",
            "end_date": "2025-07-15",
            "reason": "VACATION"
        }
        ```
  * **`PUT https://api.yourcompany.com.br/offer/slots`**: Internal endpoint for the Offer Management system itself to receive the updates generated by Offer Correction. (This could be an internal microservice process).
      * **Example Request**:
        ```json
        {
            "city_id": "SP",
            "date": "2025-07-10",
            "updated_slots": [
                {"start_time": "08:00", "availability": 10},
                {"start_time": "08:30", "availability": 8}
            ]
        }
        ```
